---
import Layout from '../../../layouts/PageLayout.astro';
import { fetchCategoriesOnly, fetchProductsByCategorySlug } from '../../../lib/medusa-adapter'
import Metadata from '~/components/common/Metadata.astro';
import DiscountCardClient from '~/components/widgets/DiscountCardClient';

import { USE_API } from "~/lib/useApiFlag";

export const prerender = !USE_API;

export async function getStaticPaths() {
  if (USE_API) {
    // SSR módban semmit sem kell visszaadni
    return [];
  }

  // SSG módban lekéri a kategóriákat
  const categories = await fetchCategoriesOnly();
  return categories.map((cat) => ({
    params: { kategoria: cat.slug },
  }));
}

const { params } = Astro;
const currentCategory = await fetchProductsByCategorySlug(params.kategoria)

if (!currentCategory) {
  throw new Error(`A(z) "${params.kategoria}" kategória nem található.`);
}

const base = 'https://elviratuzep.hu';
const catUrl = `${base}/termekek/${currentCategory.slug}`;
const pageId = `${catUrl}#collection`;
const listId = `${catUrl}#itemlist`;
const breadcrumbId = `${catUrl}#breadcrumb`;
const faqId = `${catUrl}#faq`;

const schema = [
  // 1) CollectionPage (oldal leírása)
  {
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    "@id": pageId,
    "url": catUrl,
    "name": currentCategory.category,
    "description": currentCategory.meta?.description || currentCategory.description || `${currentCategory.category} kategória – Elvira Tüzép`,
    "inLanguage": "hu",
    "isPartOf": { "@type": "WebSite", "@id": `${base}/#website`, "url": base, "name": "Elvira Tüzép" },
    "publisher": { "@id": "https://elviratuzep.hu/#store" },
    "mainEntity": { "@id": listId } // hivatkozunk az ItemList-re
  },

  // 2) ItemList (a termékek listája)
  {
    "@context": "https://schema.org",
    "@type": "ItemList",
    "@id": listId,
    "name": currentCategory.category,
    "itemListOrder": "https://schema.org/ItemListOrderAscending",
    "numberOfItems": currentCategory.products.length,
    "itemListElement": currentCategory.products.map((product, index) => ({
      "@type": "ListItem",
      "position": index + 1,
      "name": product.name,
      "url": `${base}/termekek/${currentCategory.slug}/${product.slug}`
    }))
  },

  // 3) BreadcrumbList (morzsa)
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "@id": breadcrumbId,
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Főoldal",   "item": `${base}/` },
      { "@type": "ListItem", "position": 2, "name": "Termékek",  "item": `${base}/termekek` },
      { "@type": "ListItem", "position": 3, "name": currentCategory.category, "item": catUrl }
    ]
  }
];

const faqs = currentCategory?.faq?.filter(f => f?.question && f?.answer) ?? [];

const faqSchema =
  faqs.length === 0
    ? null
    : {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "@id": faqId,
        "inLanguage": "hu",
        "isPartOf": {
          "@type": "WebSite",
          "@id": `${base}/#website`,
          "url": base,
          "name": "Elvira Tüzép"
        },
        "publisher": { "@id": "https://elviratuzep.hu/#store" },
        "mainEntity": faqs.map(f => ({
          "@type": "Question",
          "name": f.question,
          "acceptedAnswer": { "@type": "Answer", "text": f.answer }
        }))
      };

const products = currentCategory.products;
const showDescription = !!currentCategory.description;

const metadata = {
  title: currentCategory.meta?.title ?? 'Termékek | ElviraTüzép',
  description: currentCategory.meta?.description ?? 'Fedezze fel termék kínálatunkat | BSH, KVH, gyalult fa, szárított fűrészáru, lambéria, brikett egy helyen. Minőségi termékek, gyors kiszállítással.',
  openGraph: {
    title: currentCategory.meta?.title ?? 'Termékek | ElviraTüzép',
    description: currentCategory.meta?.description ?? 'Fedezze fel termék kínálatunkat | BSH, KVH, gyalult fa, szárított fűrészáru, lambéria, brikett egy helyen. Minőségi termékek, gyors kiszállítással.',
    image: currentCategory.meta?.image ?? '/kategoriak/termekek_cover.jpg',
  },
  twitter: {
    title: currentCategory.meta?.title ?? 'Termékek | ElviraTüzép',
    description: currentCategory.meta?.description ?? 'Fedezze fel termék kínálatunkat | BSH, KVH, gyalult fa, szárított fűrészáru, lambéria, brikett egy helyen. Minőségi termékek, gyors kiszállítással.',
    image: currentCategory.meta?.image ?? '/kategoriak/termekek_cover.jpg',
  }
};

const title = 'Gyakran ismételt kérdések'
const id = 'faq-section'
---

<Layout metadata={metadata}>
    {schema && (
    <script
        type="application/ld+json"
        slot="head"
        set:html={JSON.stringify(schema)}
    />
    )}
    {faqs.length > 0 && (
    <script
        type="application/ld+json"
        slot="head"
        set:html={JSON.stringify(faqSchema)}
    />
    )}

  <section class="py-12">
    <div class="container max-w-4xl mx-auto px-4">

      <!-- Breadcrumb -->
      <div class="sticky top-[70px] 2xl:top-[90px] z-20 bg-white dark:bg-gray-900 px-4 py-2 shadow-sm">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between text-sm text-gray-500 dark:text-gray-400 mb-0">
          
          <nav class="mb-2 sm:mb-0" aria-label="Breadcrumb">
            <a href="/" class="hover:underline">Főoldal</a> /
            <a href="/termekek" class="hover:underline">Termékek</a> /
            <span class="font-medium text-gray-800 dark:text-gray-200">{currentCategory.category}</span>
          </nav>

      <!--     <a href="/termekek" class="text-orange-500 hover:underline dark:text-blue-400">
            ← Vissza a termékkategóriákhoz
          </a> -->
        </div>
      </div>

      <h1 class="text-3xl font-bold mb-6 pt-10">{currentCategory.category}</h1>

      {showDescription && (
        <p class="text-gray-700 dark:text-gray-300 mb-10 leading-relaxed max-w-3xl">
          {currentCategory.description}
        </p>
      )}

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {products.map((p, i) => (
          <DiscountCardClient
            key={(p.id as any) ?? p.sku ?? p.slug ?? i}
            product={p}
            currentCategorySlug={currentCategory.slug}
          />
        ))}
      </div>
    </div>
  </section>
  {faqs.length > 0 && (
    <section aria-labelledby={id} class="my-10">
      <div class="container max-w-4xl mx-auto px-4">
        <h2 id={id} class="mb-4 text-2xl font-semibold tracking-tight text-zinc-900 dark:text-zinc-100">
          {title}
        </h2>

        {currentCategory.faqdesc && (
          <p class="mb-4 text-zinc-700 dark:text-zinc-300 leading-relaxed">
            {currentCategory.faqdesc}
          </p>
        )}

        <div class="space-y-3">
  {currentCategory.faq.map((item, idx) => (
    <details
      id={item.id ? item.id : `faq-${idx}`}
      class="group rounded-xl border border-zinc-200 dark:border-zinc-700 
             bg-white/70 dark:bg-zinc-900/60 backdrop-blur shadow-sm 
             open:shadow-md transition-shadow"
    >
      <summary
        class="flex cursor-pointer items-center justify-between gap-3 p-4 
               text-left select-none font-medium text-zinc-900 dark:text-zinc-100 
               marker:content-['']"
      >
        <h3 class="leading-snug text-base font-medium m-0">{item.question}</h3>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="shrink-0 transition-transform duration-200 group-open:rotate-180 text-zinc-600 dark:text-zinc-300"
        >
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      </summary>

      <div class="px-4 pb-4 pt-0 text-zinc-700 dark:text-zinc-300 leading-relaxed">
        {/* Ha az answer tartalmazhat HTML-t, engedélyezd így: */}
        <div set:html={item.answer}></div>
        {/* Ha biztosan plain text, akkor: */}
        {/* <p>{item.answer}</p> */}
      </div>
    </details>
  ))}
</div>


      </div>
    </section>
  )}
</Layout>
